<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chord-Set Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom horizontal scrollbar for Step 2 */
    #type-buttons::-webkit-scrollbar {
      height: 6px;
    }
    #type-buttons::-webkit-scrollbar-track {
      background: transparent;
    }
    #type-buttons::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
    }
    #type-buttons:hover::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.35);
    }
    /* Firefox */
    #type-buttons {
      scrollbar-color: rgba(0,0,0,0.25) transparent;
      scrollbar-width: thin;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans p-4">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-6 text-center">ðŸŽµ Chord-Set Maker</h1>

    <!-- Step 1 -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">1. Choose Root Note</h2>
      <div id="root-buttons" class="flex overflow-x-auto gap-2 pb-1"></div>
    </section>

    <!-- Step 2 -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">2. Choose Chord Type</h2>
      <div id="type-buttons" class="flex overflow-x-auto gap-2 pb-1"></div>
    </section>

    <!-- Step 3 -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">3. Add to Current Set</h2>
      <div class="flex flex-wrap gap-3 items-end mb-3">
        <div class="flex flex-col">
          <label class="text-sm mb-1">Repeat</label>
          <select id="repeat-count" class="border rounded px-3 py-1 w-20">
            <option value="1" selected>Ã—1</option>
            <option value="2">Ã—2</option>
            <option value="4">Ã—4</option>
            <option value="8">Ã—8</option>
          </select>
        </div>
        <button onclick="addToCurrentSet()" class="bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700">Add Chord</button>
        <div class="flex flex-col">
          <label for="setName" class="text-sm mb-1">Set Name</label>
          <input id="setName" type="text" placeholder="e.g. Intro" class="border rounded px-3 py-1 w-48"/>
        </div>
        <button onclick="saveCurrentSet()" class="bg-green-600 text-white px-4 py-2 rounded-xl hover:bg-green-700">Save Set</button>
      </div>

      <div class="bg-gray-50 p-4 rounded-md text-sm space-y-2 border border-gray-200 shadow-sm">
        <div>
          <span class="font-semibold text-gray-600">Selected Chord:</span>
          <span id="selected-chord" class="ml-2 text-blue-700 font-mono">None</span>
        </div>
        <div>
          <span class="font-semibold text-gray-600">Current Set:</span>
          <span id="current-set" class="ml-2 text-gray-800 font-mono">Empty</span>
        </div>
      </div>
    </section>

    <!-- Step 4 -->
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">4. Saved Sets</h2>
      <div id="sets-display" class="grid gap-4 md:grid-cols-2"></div>
    </section>

    <!-- Step 5 -->
    <section>
      <h2 class="text-lg font-semibold mb-2">5. Download MIDI ZIP</h2>
      <button onclick="exportToFile()" class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition">Download MIDI ZIP</button>
    </section>
  </div>

  <script>
    const roots = ["C","C#/Dâ™­","D","D#/Eâ™­","E","F","F#/Gâ™­","G","G#/Aâ™­","A","A#/Bâ™­","B"];
    const types = ["M","m","7","maj7","m7","mM7","dim","aug","sus4","m7-5","add9","7sus4","aug7","7-5","7+5","6","m6","7(#9)","7-9","9","m9","maj9"];
    let selectedRoot = null, selectedType = null, sets = [], currentChords = [];

    const normalizeRoot = root => root.split("/")[0];

    const updateOutput = () => {
      document.getElementById("selected-chord").textContent = selectedRoot && selectedType ? selectedRoot + selectedType : "None";
      document.getElementById("current-set").textContent = currentChords.length ? currentChords.join(" ") : "Empty";
    };

    const makeButton = (label, isRoot) => {
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className = "bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded whitespace-nowrap";
      btn.addEventListener("click", () => {
        btn.parentElement.querySelectorAll("button").forEach(b => b.classList.remove("bg-blue-500", "text-white"));
        btn.classList.add("bg-blue-500", "text-white");
        isRoot ? selectedRoot = normalizeRoot(label) : selectedType = label;
        updateOutput();
      });
      return btn;
    };

    const addToCurrentSet = () => {
      if (!selectedRoot || !selectedType) return alert("Please select both root and chord type.");
      const chord = selectedRoot + selectedType;
      const repeat = parseInt(document.getElementById("repeat-count").value, 10);
      currentChords.push(...Array(repeat).fill(chord));
      updateOutput();
    };

    const saveCurrentSet = () => {
      if (!currentChords.length) return alert("Current set is empty.");
      const nameInput = document.getElementById("setName");
      const name = nameInput.value.trim() || `Set ${sets.length + 1}`;
      const existing = sets.find(s => s.name === name);
      existing ? existing.chords = [...currentChords] : sets.push({ name, chords: [...currentChords] });
      currentChords = [];
      nameInput.value = "";
      document.querySelectorAll('#root-buttons button, #type-buttons button').forEach(b => b.classList.remove("bg-blue-500", "text-white"));
      selectedRoot = selectedType = null;
      updateOutput();
      renderSets();
    };

    const copySet = index => {
      const original = sets[index];
      let baseName = original.name.replace(/ \(copy.*\)/, '');
      let copyName = `${baseName} (copy)`, suffix = 1;
      while (sets.find(s => s.name === copyName)) copyName = `${baseName} (copy ${++suffix})`;
      sets.push({ name: copyName, chords: [...original.chords] });
      renderSets();
    };

    const deleteSet = index => { sets.splice(index, 1); renderSets(); };

    const renderSets = () => {
      const container = document.getElementById("sets-display");
      container.innerHTML = "";
      sets.forEach((set, idx) => {
        const card = document.createElement("div");
        card.className = "bg-gray-50 border rounded-xl p-4 shadow-sm";
        card.draggable = true;
        card.dataset.index = idx;
        card.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-semibold text-sm truncate">${set.name}</h3>
            <div class="text-xs space-x-2">
              <button onclick="copySet(${idx})" class="text-blue-500 hover:underline">Copy</button>
              <button onclick="deleteSet(${idx})" class="text-red-500 hover:underline">Delete</button>
            </div>
          </div>
          <p class="text-sm break-words">${set.chords.join(" ")}</p>
        `;
        card.addEventListener("dragstart", e => { e.dataTransfer.setData("text/plain", idx); e.currentTarget.style.opacity = "0.5"; });
        card.addEventListener("dragend", e => { e.currentTarget.style.opacity = "1"; });
        card.addEventListener("dragover", e => { e.preventDefault(); e.dataTransfer.dropEffect = "move"; });
        card.addEventListener("drop", e => {
          e.preventDefault();
          const fromIdx = parseInt(e.dataTransfer.getData("text/plain")), toIdx = parseInt(card.dataset.index);
          if (fromIdx !== toIdx) {
            const moved = sets.splice(fromIdx, 1)[0];
            sets.splice(toIdx, 0, moved);
            renderSets();
          }
        });
        container.appendChild(card);
      });
    };

    const exportToFile = () => {
      if (!sets.length) return alert("Nothing to export.");
      const lines = sets.map(s => `${s.name}: ${s.chords.join(" ")}`);
      fetch("/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chord_data: lines.join("\n") })
      })
      .then(r => r.ok ? r.blob() : Promise.reject("Server error"))
      .then(blob => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "chords_output.zip";
        link.click();
      })
      .catch(e => alert(e));
    };

    roots.forEach(r => document.getElementById("root-buttons").appendChild(makeButton(r, true)));
    types.forEach(t => document.getElementById("type-buttons").appendChild(makeButton(t, false)));
    updateOutput();
  </script>
</body>
</html>
